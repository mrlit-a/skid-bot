(async () => {
require("./settings")
const { default: makeWASocket, useMultiFileAuthState, DisconnectReason, proto , jidNormalizedUser,WAMessageStubType, generateForwardMessageContent, prepareWAMessageMedia, generateWAMessageFromContent, generateMessageID, downloadContentFromMessage } = require("@whiskeysockets/baileys")
const { state, saveCreds } = await useMultiFileAuthState('./authFolder')
const chalk = require('chalk')
const moment = require('moment')
const { smsg } = require('./libs/fuctions')

const { execSync } = require('child_process')
const pino = require('pino')
const color = (text, color) => {
return !color ? chalk.green(text) : color.startsWith('#') ? chalk.hex(color)(text) : chalk.keyword(color)(text)
}

async function startBot() {

const sock = makeWASocket({
    printQRInTerminal: true,
    auth: state,
    logger: pino({ level: 'silent' })
})

sock.ev.on('messages.upsert', async chatUpdate => {
    //console.log(JSON.stringify(chatUpdate, undefined, 2))
    try {
    chatUpdate.messages.forEach(async (mek) => {
    try {
    //mek = (Object.keys(chatUpdate.messages[0])[0] !== "senderKeyDistributionMessage") ?  chatUpdate.messages[0] : chatUpdate.messages[1]

    if (!mek.message) return
    //console.log(chatUpdate.type)
    mek.message = (Object.keys(mek.message)[0] === 'ephemeralMessage') ? mek.message.ephemeralMessage.message : mek.message
    if (mek.key && mek.key.remoteJid === 'status@broadcast') return
    
    if (!chatUpdate.type === 'notify') return
    m = smsg(sock, mek)
    //if (m.key.fromMe === true) return
    //if (m.mtype === 'senderKeyDistributionMessage') mek = chatUpdate.messages[1]
    require("./skid")(sock, m, chatUpdate, mek)
    } catch (e) {
    console.log(e)
    }
    })
    } catch (err) {
        console.log(err)
    }
})

sock.ev.on('connection.update', async (update) => {
    const { connection, lastDisconnect, qr, receivedPendingNotifications } = update;
    console.log(receivedPendingNotifications)
    if (connection == 'connecting') {
        console.log(
            color('[SYS]', '#009FFF'),
            color(moment().format('DD/MM/YY HH:mm:ss'), '#A1FFCE'),
            color(`â•­â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â€¢ ${vs} â€¢ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆâ•®\nâ”ŠğŸ§¡ INICIANDO AGUARDE UN MOMENTO...\nâ•°â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆâ•¯`, '#f12711')
        );
    } else if (qr !== undefined) {
        console.log(
            color('[SYS]', '#009FFF'),
            color(moment().format('DD/MM/YY HH:mm:ss'), '#A1FFCE'),
            color(`â•­â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â€¢ ${vs} â€¢ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆâ•®\nâ”ŠESCANEA EL QR, EXPIRA 45 SEG...\nâ•°â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆâ•¯`, '#f12711')
        );
    } else if (connection === 'close') {
        console.log(
            color('[SYS]', '#009FFF'),
            color(moment().format('DD/MM/YY HH:mm:ss'), '#A1FFCE'),
            color(`âš ï¸ CONEXION CERRADA, SE INTENTARA RECONECTAR`, '#f64f59')
        );
        lastDisconnect.error?.output?.statusCode !== DisconnectReason.loggedOut
            ? startBot()
            : console.log(
                color('[SYS]', '#009FFF'),
                color(moment().format('DD/MM/YY HH:mm:ss'), '#A1FFCE'),
                color(`Wa Web logged Out`, '#f64f59')
            );;
    } else if (connection == 'open') {
        console.log(
            color('[SYS]', '#009FFF'),
            color(moment().format('DD/MM/YY HH:mm:ss'), '#A1FFCE'),
            color(`â•­â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â€¢ ${vs} â€¢ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆâ•®\nâ”ŠğŸ§¡ SkidBot Se Conecto Correctamente a WhatsApp\nâ•°â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆ â”ˆâ•¯`, '#38ef7d')
        );
    }
});


sock.ev.on('creds.update', saveCreds)

process.on('uncaughtException', console.log)
process.on('unhandledRejection', console.log)
process.on('RefenceError', console.log)


}

startBot()

})()

startBot()

})()
